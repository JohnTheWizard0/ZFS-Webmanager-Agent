openapi: 3.0.3
info:
  title: ZFS Web Manager API
  description: |
    RESTful API for managing ZFS pools, datasets, and snapshots.

    ## Authentication
    All endpoints (except `/v1/health` and `/v1/docs`) require an API key passed via the `X-API-Key` header.
    The API key is generated on first run and stored in `~/.zfs_webmanager/api_key`.

    ## Error Handling
    All endpoints return JSON with a `status` field. On error:
    ```json
    {"status": "error", "message": "Description of the error"}
    ```
  version: 0.3.3
  contact:
    name: ZFS Agent
  license:
    name: MIT

servers:
  - url: http://localhost:9876/v1
    description: Local development server (API v1)

security:
  - ApiKeyAuth: []

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication

  schemas:
    # Common response types
    ActionResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          example: Operation completed successfully
      required:
        - status
        - message

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: Failed to perform operation
      required:
        - status
        - message

    # Health
    LastAction:
      type: object
      properties:
        function:
          type: string
          example: list_pools
        timestamp:
          type: integer
          format: int64
          example: 1733536800

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        version:
          type: string
          example: "0.3.3"
        last_action:
          $ref: '#/components/schemas/LastAction'
          nullable: true
      required:
        - status
        - version

    # Pool types
    PoolListResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        pools:
          type: array
          items:
            type: string
          example: ["tank", "backup"]
      required:
        - status
        - pools

    PoolStatusResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        name:
          type: string
          example: tank
        health:
          type: string
          enum: [Online, Degraded, Faulted, Offline, Removed, Unavail]
          example: Online
        size:
          type: integer
          format: int64
          description: Total size in bytes
          example: 1099511627776
        allocated:
          type: integer
          format: int64
          description: Allocated space in bytes
          example: 549755813888
        free:
          type: integer
          format: int64
          description: Free space in bytes
          example: 549755813888
        capacity:
          type: integer
          minimum: 0
          maximum: 100
          description: Capacity percentage
          example: 50
        vdevs:
          type: integer
          description: Number of virtual devices
          example: 2
        errors:
          type: string
          nullable: true
          description: Error message if any
      required:
        - status
        - name
        - health
        - size
        - allocated
        - free
        - capacity
        - vdevs

    CreatePoolRequest:
      type: object
      properties:
        name:
          type: string
          description: Pool name
          example: tank
        disks:
          type: array
          items:
            type: string
          description: List of disk paths
          example: ["/dev/sda", "/dev/sdb"]
        raid_type:
          type: string
          enum: [mirror, raidz, raidz2, raidz3]
          nullable: true
          description: RAID type (optional for single disk)
          example: mirror
      required:
        - name
        - disks

    # Scrub types
    ScrubStatusResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        pool:
          type: string
          example: tank
        pool_health:
          type: string
          example: Online
        pool_errors:
          type: string
          nullable: true
        scan_state:
          type: string
          enum: [none, scanning, finished, canceled]
          description: Current scan state
          example: scanning
        scan_function:
          type: string
          enum: [scrub, resilver, errorscrub]
          nullable: true
          description: Type of scan operation
          example: scrub
        start_time:
          type: integer
          format: int64
          nullable: true
          description: Unix timestamp when scan started
          example: 1733536800
        end_time:
          type: integer
          format: int64
          nullable: true
          description: Unix timestamp when scan ended
        to_examine:
          type: integer
          format: int64
          nullable: true
          description: Total bytes to examine
          example: 1099511627776
        examined:
          type: integer
          format: int64
          nullable: true
          description: Bytes examined so far
          example: 549755813888
        scan_errors:
          type: integer
          format: int64
          nullable: true
          description: Number of errors found
          example: 0
        percent_done:
          type: number
          format: double
          nullable: true
          description: Percentage complete (0-100)
          example: 50.0
      required:
        - status
        - pool
        - pool_health
        - scan_state

    # Import/Export types
    ExportPoolRequest:
      type: object
      properties:
        force:
          type: boolean
          default: false
          description: Force export even if filesystems are in use

    ImportPoolRequest:
      type: object
      properties:
        name:
          type: string
          description: Pool name to import
          example: tank
        dir:
          type: string
          nullable: true
          description: Directory to search for pool (optional)
          example: /dev/disk/by-id
      required:
        - name

    ImportablePoolInfo:
      type: object
      properties:
        name:
          type: string
          example: tank
        health:
          type: string
          example: Online
      required:
        - name
        - health

    ImportablePoolsResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        pools:
          type: array
          items:
            $ref: '#/components/schemas/ImportablePoolInfo'
      required:
        - status
        - pools

    # Dataset types
    DatasetResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        datasets:
          type: array
          items:
            type: string
          example: ["tank", "tank/data", "tank/backup"]
      required:
        - status
        - datasets

    CreateDatasetRequest:
      type: object
      properties:
        name:
          type: string
          description: Full dataset path
          example: tank/data
        kind:
          type: string
          enum: [filesystem, volume]
          description: Dataset type
          example: filesystem
        properties:
          type: object
          additionalProperties:
            type: string
          nullable: true
          description: Optional ZFS properties
          example:
            compression: lz4
            quota: 10G
      required:
        - name
        - kind

    DatasetPropertiesResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        name:
          type: string
          example: tank/data
        dataset_type:
          type: string
          enum: [filesystem, volume, snapshot, bookmark, unknown]
          example: filesystem
        available:
          type: integer
          format: int64
          nullable: true
          description: Available space in bytes
        used:
          type: integer
          format: int64
          nullable: true
          description: Used space in bytes
        referenced:
          type: integer
          format: int64
          nullable: true
          description: Referenced space in bytes
        compression:
          type: string
          nullable: true
          example: lz4
        compression_ratio:
          type: number
          format: double
          nullable: true
          example: 1.5
        readonly:
          type: boolean
          nullable: true
        creation:
          type: integer
          format: int64
          nullable: true
          description: Creation timestamp
        quota:
          type: integer
          format: int64
          nullable: true
          description: Quota in bytes (0 = none)
        reservation:
          type: integer
          format: int64
          nullable: true
        mountpoint:
          type: string
          nullable: true
          example: /tank/data
        mounted:
          type: boolean
          nullable: true
        checksum:
          type: string
          nullable: true
          example: on
        copies:
          type: integer
          nullable: true
          example: 1
        atime:
          type: boolean
          nullable: true
        exec:
          type: boolean
          nullable: true
        setuid:
          type: boolean
          nullable: true
        dedup:
          type: string
          nullable: true
          example: off
        sync:
          type: string
          nullable: true
          example: standard
        user_properties:
          type: object
          additionalProperties:
            type: string
          description: User-defined properties
      required:
        - status
        - name
        - dataset_type

    SetPropertyRequest:
      type: object
      description: "**EXPERIMENTAL**: Set property request (uses CLI fallback)"
      properties:
        property:
          type: string
          description: Property name (e.g., compression, quota, user:custom)
          example: compression
        value:
          type: string
          description: Property value
          example: lz4
      required:
        - property
        - value

    # Snapshot types
    ListResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        items:
          type: array
          items:
            type: string
          example: ["tank/data@backup-001", "tank/data@backup-002"]
      required:
        - status
        - items

    CreateSnapshotRequest:
      type: object
      properties:
        snapshot_name:
          type: string
          description: Snapshot name (without @)
          example: backup-2025-01-01
      required:
        - snapshot_name

    # Clone/Promote types (MF-003 Phase 3)
    CloneSnapshotRequest:
      type: object
      description: Request to clone a snapshot
      properties:
        target:
          type: string
          description: Full path for the new clone dataset
          example: tank/data-clone
      required:
        - target

    CloneResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        origin:
          type: string
          description: Source snapshot path
          example: tank/data@backup-001
        clone:
          type: string
          description: New clone dataset path
          example: tank/data-clone
      required:
        - status
        - origin
        - clone

    PromoteResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        dataset:
          type: string
          description: Promoted dataset path
          example: tank/data-clone
        message:
          type: string
          description: Description of the operation result
          example: "Dataset 'tank/data-clone' promoted successfully. Former parent is now a clone."
      required:
        - status
        - dataset
        - message

    # Rollback types (MF-003 Phase 3)
    RollbackRequest:
      type: object
      description: |
        Request to rollback a dataset to a snapshot.

        Safety levels:
        - Default: Only allows rollback to most recent snapshot
        - force_destroy_newer: Destroys intermediate snapshots (like zfs rollback -r)
        - force_destroy_newer + force_destroy_clones: Also destroys clones (like zfs rollback -R)

        Note: force_destroy_clones requires force_destroy_newer to be true.
      properties:
        snapshot:
          type: string
          description: Target snapshot name (without @)
          example: backup-001
        force_destroy_newer:
          type: boolean
          default: false
          description: Destroy snapshots newer than target (like -r flag)
        force_destroy_clones:
          type: boolean
          default: false
          description: Also destroy clones of newer snapshots (like -R flag). Requires force_destroy_newer.
      required:
        - snapshot

    RollbackResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        dataset:
          type: string
          description: Dataset that was rolled back
          example: tank/data
        snapshot:
          type: string
          description: Snapshot rolled back to
          example: backup-001
        message:
          type: string
          description: Description of the operation result
          example: "Dataset 'tank/data' rolled back successfully"
        destroyed_snapshots:
          type: array
          items:
            type: string
          nullable: true
          description: List of snapshots destroyed (if force_destroy_newer was used)
          example: ["tank/data@backup-002", "tank/data@backup-003"]
        destroyed_clones:
          type: array
          items:
            type: string
          nullable: true
          description: List of clones destroyed (if force_destroy_clones was used)
          example: ["tank/data-clone"]
      required:
        - status
        - dataset
        - snapshot
        - message

    RollbackBlockedResponse:
      type: object
      description: Returned when rollback is blocked by newer snapshots or clones
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          description: Description of what is blocking the rollback
          example: "Cannot rollback to 'tank/data@backup-001': 2 newer snapshot(s) exist"
        blocking_snapshots:
          type: array
          items:
            type: string
          description: Snapshots that are blocking the rollback
          example: ["tank/data@backup-002", "tank/data@backup-003"]
        blocking_clones:
          type: array
          items:
            type: string
          description: Clones that are blocking the rollback
          example: ["tank/data-clone"]
      required:
        - status
        - message
        - blocking_snapshots
        - blocking_clones

    # ZFS Features Discovery types
    ImplementationMethod:
      type: string
      enum: [libzetta, ffi, libzfs, cli_experimental, planned]
      description: |
        How the feature is implemented:
        - libzetta: Uses libzetta library bindings
        - ffi: FROM-SCRATCH FFI implementation (lzc_* functions)
        - libzfs: Uses libzfs FFI bindings directly
        - cli_experimental: EXPERIMENTAL fallback to CLI (zfs/zpool commands)
        - planned: Not yet implemented

    FeatureCategory:
      type: string
      enum: [pool, dataset, snapshot, property, replication, system]
      description: Category of ZFS feature

    ZfsFeatureInfo:
      type: object
      description: Information about a single ZFS feature
      properties:
        name:
          type: string
          description: Feature name
          example: Clone snapshot
        category:
          $ref: '#/components/schemas/FeatureCategory'
        implemented:
          type: boolean
          description: Whether the feature is currently implemented
          example: true
        implementation:
          $ref: '#/components/schemas/ImplementationMethod'
        endpoint:
          type: string
          nullable: true
          description: API endpoint for this feature (if implemented)
          example: "POST /v1/snapshots/{dataset}/{name}/clone"
        notes:
          type: string
          nullable: true
          description: Additional notes about the implementation
          example: "FROM-SCRATCH lzc_clone() FFI"
      required:
        - name
        - category
        - implemented

    FeatureSummary:
      type: object
      description: Summary counts of features
      properties:
        total:
          type: integer
          description: Total number of features tracked
          example: 32
        implemented:
          type: integer
          description: Number of implemented features
          example: 27
        planned:
          type: integer
          description: Number of planned features
          example: 5
      required:
        - total
        - implemented
        - planned

    ZfsFeaturesResponse:
      type: object
      description: Response listing all ZFS features and their implementation status
      properties:
        status:
          type: string
          example: success
        version:
          type: string
          description: API version
          example: "0.3.3"
        summary:
          $ref: '#/components/schemas/FeatureSummary'
        features:
          type: array
          items:
            $ref: '#/components/schemas/ZfsFeatureInfo'
      required:
        - status
        - version
        - summary
        - features

    # Command types
    CommandRequest:
      type: object
      properties:
        command:
          type: string
          description: Command to execute
          example: zpool
        args:
          type: array
          items:
            type: string
          nullable: true
          description: Command arguments
          example: ["status", "-v"]
      required:
        - command

    CommandResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        output:
          type: string
          description: Combined stdout and stderr
          example: "  pool: tank\n state: ONLINE\n"
        exit_code:
          type: integer
          description: Process exit code
          example: 0
      required:
        - status
        - output
        - exit_code

paths:
  /health:
    get:
      summary: Health check
      description: Returns server status, version, and last action
      operationId: healthCheck
      security: []
      tags:
        - Health
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /features:
    get:
      summary: List ZFS features
      description: |
        Returns all ZFS features with their implementation status.

        This endpoint shows:
        - Which features are implemented vs planned
        - How each feature is implemented (libzetta, FFI, CLI, etc.)
        - Which API endpoint corresponds to each feature
        - Any notes about the implementation

        No authentication required - this is an informational endpoint.
      operationId: listZfsFeatures
      security: []
      tags:
        - System
      responses:
        '200':
          description: List of all ZFS features
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ZfsFeaturesResponse'
              example:
                status: success
                version: "0.3.3"
                summary:
                  total: 32
                  implemented: 27
                  planned: 5
                features:
                  - name: Clone snapshot
                    category: snapshot
                    implemented: true
                    implementation: ffi
                    endpoint: "POST /v1/snapshots/{dataset}/{name}/clone"
                    notes: "FROM-SCRATCH lzc_clone() FFI"
                  - name: Send snapshot
                    category: replication
                    implemented: false
                    implementation: planned
                    endpoint: null
                    notes: "zfs send equivalent"

  /pools:
    get:
      summary: List pools
      description: Returns list of all ZFS pool names
      operationId: listPools
      tags:
        - Pools
      responses:
        '200':
          description: List of pool names
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolListResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      summary: Create pool
      description: Create a new ZFS pool
      operationId: createPool
      tags:
        - Pools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePoolRequest'
      responses:
        '200':
          description: Pool created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pools/importable:
    get:
      summary: List importable pools
      description: Discover pools available for import
      operationId: listImportablePools
      tags:
        - Pools
      parameters:
        - name: dir
          in: query
          description: Directory to search (defaults to /dev/)
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of importable pools
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImportablePoolsResponse'

  /pools/import:
    post:
      summary: Import pool
      description: Import an exported ZFS pool
      operationId: importPool
      tags:
        - Pools
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ImportPoolRequest'
      responses:
        '200':
          description: Pool imported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'
        '400':
          description: Import failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pools/{name}:
    get:
      summary: Get pool status
      description: Returns detailed status of a specific pool
      operationId: getPoolStatus
      tags:
        - Pools
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: Pool status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolStatusResponse'
        '404':
          description: Pool not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      summary: Destroy pool
      description: Destroy a ZFS pool
      operationId: destroyPool
      tags:
        - Pools
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
        - name: force
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Force destroy
      responses:
        '200':
          description: Pool destroyed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /pools/{name}/export:
    post:
      summary: Export pool
      description: Export a pool from the system
      operationId: exportPool
      tags:
        - Pools
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportPoolRequest'
      responses:
        '200':
          description: Pool exported
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /pools/{name}/scrub:
    get:
      summary: Get scrub status
      description: Returns current scrub/resilver status with progress
      operationId: getScrubStatus
      tags:
        - Scrub
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: Scrub status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScrubStatusResponse'

    post:
      summary: Start scrub
      description: Start or resume a scrub on the pool
      operationId: startScrub
      tags:
        - Scrub
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: Scrub started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /pools/{name}/scrub/pause:
    post:
      summary: Pause scrub
      description: Pause an active scrub
      operationId: pauseScrub
      tags:
        - Scrub
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: Scrub paused
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /pools/{name}/scrub/stop:
    post:
      summary: Stop scrub
      description: Stop/cancel an active scrub
      operationId: stopScrub
      tags:
        - Scrub
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: Scrub stopped
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /datasets/{pool}:
    get:
      summary: List datasets
      description: List all datasets in a pool
      operationId: listDatasets
      tags:
        - Datasets
      parameters:
        - name: pool
          in: path
          required: true
          schema:
            type: string
          description: Pool name
      responses:
        '200':
          description: List of datasets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatasetResponse'

  /datasets:
    post:
      summary: Create dataset
      description: Create a new filesystem or volume
      operationId: createDataset
      tags:
        - Datasets
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateDatasetRequest'
      responses:
        '200':
          description: Dataset created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /datasets/{path}:
    delete:
      summary: Delete dataset
      description: Delete a dataset (supports nested paths like pool/dataset/child)
      operationId: deleteDataset
      tags:
        - Datasets
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Full dataset path
      responses:
        '200':
          description: Dataset deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /datasets/{path}/properties:
    get:
      summary: Get dataset properties
      description: Returns all properties of a dataset (filesystem, volume, or snapshot)
      operationId: getDatasetProperties
      tags:
        - Datasets
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Full dataset path (e.g., pool/dataset)
      responses:
        '200':
          description: Dataset properties
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DatasetPropertiesResponse'
        '404':
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      summary: Set dataset property
      description: |
        Set a property on a dataset.

        **EXPERIMENTAL**: Uses CLI (`zfs set`) as libzetta/libzfs FFI lacks property setting bindings.

        Common properties:
        - `compression`: lz4, gzip, off
        - `quota`: Size limit (e.g., "10G", "100M", "0" for none)
        - `readonly`: on/off
        - `atime`: on/off
        - `sync`: standard/always/disabled
        - `user:custom`: User-defined properties
      operationId: setDatasetProperty
      tags:
        - Datasets
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Full dataset path
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetPropertyRequest'
      responses:
        '200':
          description: Property set
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'
        '400':
          description: Invalid property or value
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /snapshots/{dataset}:
    get:
      summary: List snapshots
      description: List all snapshots for a dataset (supports nested paths)
      operationId: listSnapshots
      tags:
        - Snapshots
      parameters:
        - name: dataset
          in: path
          required: true
          schema:
            type: string
          description: Dataset path (e.g., pool/dataset)
      responses:
        '200':
          description: List of snapshots
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListResponse'

    post:
      summary: Create snapshot
      description: Create a new snapshot
      operationId: createSnapshot
      tags:
        - Snapshots
      parameters:
        - name: dataset
          in: path
          required: true
          schema:
            type: string
          description: Dataset path
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateSnapshotRequest'
      responses:
        '200':
          description: Snapshot created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /snapshots/{dataset}/{snapshot}:
    delete:
      summary: Delete snapshot
      description: Delete a snapshot
      operationId: deleteSnapshot
      tags:
        - Snapshots
      parameters:
        - name: dataset
          in: path
          required: true
          schema:
            type: string
          description: Dataset path
        - name: snapshot
          in: path
          required: true
          schema:
            type: string
          description: Snapshot name
      responses:
        '200':
          description: Snapshot deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActionResponse'

  /snapshots/{dataset}/{snapshot}/clone:
    post:
      summary: Clone snapshot
      description: |
        Create a writable clone from a snapshot.

        The clone shares all blocks with the original snapshot initially (copy-on-write).
        As you modify the clone, only changed blocks consume additional space.

        **Implementation**: FROM-SCRATCH using `lzc_clone()` FFI (libzetta doesn't expose this).
      operationId: cloneSnapshot
      tags:
        - Snapshots
      parameters:
        - name: dataset
          in: path
          required: true
          schema:
            type: string
          description: Dataset path (e.g., tank/data)
        - name: snapshot
          in: path
          required: true
          schema:
            type: string
          description: Snapshot name (e.g., backup-001)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CloneSnapshotRequest'
      responses:
        '200':
          description: Clone created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CloneResponse'
        '400':
          description: Invalid request (e.g., snapshot not found, target exists)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /datasets/{path}/promote:
    post:
      summary: Promote clone
      description: |
        Promote a clone to an independent dataset.

        After promotion:
        - The clone becomes the parent dataset
        - Snapshots up to and including the origin snapshot transfer to the promoted dataset
        - The former parent becomes a clone of the transferred snapshot

        **Implementation**: FROM-SCRATCH using `lzc_promote()` FFI (libzetta doesn't expose this).

        **Note**: If there are snapshot name collisions, the operation will fail with EEXIST
        and report the conflicting snapshot name.
      operationId: promoteDataset
      tags:
        - Datasets
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Clone dataset path (e.g., tank/data-clone)
      responses:
        '200':
          description: Clone promoted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PromoteResponse'
        '400':
          description: Invalid request (e.g., not a clone, snapshot name collision)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Dataset not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /datasets/{path}/rollback:
    post:
      summary: Rollback dataset
      description: |
        Rollback a dataset to a previous snapshot.

        **Safety levels**:
        - Default: Only allows rollback to most recent snapshot
        - `force_destroy_newer: true`: Destroys intermediate snapshots (like `zfs rollback -r`)
        - `force_destroy_newer: true` + `force_destroy_clones: true`: Also destroys clones (like `zfs rollback -R`)

        **Note**: `force_destroy_clones` requires `force_destroy_newer` to be true.

        **Warning**: This is a destructive operation. All data changes since the snapshot will be lost.
        If `force_destroy_newer` is used, newer snapshots will be permanently destroyed.

        **Implementation**: FROM-SCRATCH using `lzc_rollback_to()` FFI (libzetta doesn't expose this).
      operationId: rollbackDataset
      tags:
        - Datasets
      parameters:
        - name: path
          in: path
          required: true
          schema:
            type: string
          description: Dataset path (e.g., tank/data)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RollbackRequest'
      responses:
        '200':
          description: Dataset rolled back successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/RollbackResponse'
                  - $ref: '#/components/schemas/RollbackBlockedResponse'
        '400':
          description: Invalid request (e.g., force_destroy_clones without force_destroy_newer)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Dataset or snapshot not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /command:
    post:
      summary: Execute command
      description: Execute an arbitrary shell command (use with caution)
      operationId: executeCommand
      tags:
        - System
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
      responses:
        '200':
          description: Command executed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'

tags:
  - name: Health
    description: Server health and status
  - name: Pools
    description: ZFS pool operations
  - name: Scrub
    description: Pool scrub/resilver operations
  - name: Datasets
    description: ZFS dataset (filesystem/volume) operations
  - name: Snapshots
    description: ZFS snapshot operations
  - name: System
    description: System-level operations
